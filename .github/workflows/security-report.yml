name: Security Report Comment

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  security-comment:
    name: Post Security Scan Results
    runs-on: ubuntu-latest
    # Skip for template sync PRs
    if: |
      !contains(github.event.pull_request.title, 'Sync template updates from') &&
      !startsWith(github.event.pull_request.head.ref, 'template-sync-')
    steps:
    - uses: actions/checkout@v4

    - name: Run Trivy security scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        severity: 'CRITICAL,HIGH,MEDIUM'
        format: 'json'
        output: 'trivy-results.json'
        exit-code: '0'
        ignore-unfixed: true

    - name: Create security summary
      id: summary
      run: |
        # Parse JSON and create markdown summary
        echo "## ðŸ”’ Security Scan Results" > security-summary.md
        echo "" >> security-summary.md

        # Count vulnerabilities by severity
        CRITICAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json)
        HIGH=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json)
        MEDIUM=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-results.json)

        echo "| Severity | Count |" >> security-summary.md
        echo "|----------|-------|" >> security-summary.md
        echo "| ðŸ”´ CRITICAL | $CRITICAL |" >> security-summary.md
        echo "| ðŸŸ  HIGH | $HIGH |" >> security-summary.md
        echo "| ðŸŸ¡ MEDIUM | $MEDIUM |" >> security-summary.md
        echo "" >> security-summary.md

        if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
          echo "âš ï¸ **Action Required**: Critical or High severity vulnerabilities found!" >> security-summary.md
          echo "" >> security-summary.md
          echo "<details>" >> security-summary.md
          echo "<summary>View Details</summary>" >> security-summary.md
          echo "" >> security-summary.md
          echo '```' >> security-summary.md
          cat trivy-results.txt 2>/dev/null || echo "No detailed results available" >> security-summary.md
          echo '```' >> security-summary.md
          echo "</details>" >> security-summary.md
        else
          echo "âœ… No critical or high severity vulnerabilities found!" >> security-summary.md
        fi

        # Set output for PR comment
        {
          echo 'SUMMARY<<EOF'
          cat security-summary.md
          echo 'EOF'
        } >> $GITHUB_OUTPUT

    - name: Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          const summary = `${{ steps.summary.outputs.SUMMARY }}`;

          // Find existing comment
          const { data: comments } = await github.rest.issues.listComments({
            ...context.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('ðŸ”’ Security Scan Results')
          );

          // Update or create comment
          if (botComment) {
            await github.rest.issues.updateComment({
              ...context.repo,
              comment_id: botComment.id,
              body: summary
            });
          } else {
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: summary
            });
          }
      continue-on-error: true
