# SQL Database Parameter Flexibility Migration Guide

**Version**: v2.1+
**Impact**: Low to Medium (code changes, but backwards compatible)
**Scope**: SQLDatabaseNode and AsyncSQLDatabaseNode parameter handling

## Overview

Kailash SDK v2.1+ introduces enhanced parameter flexibility for SQL database nodes. The key improvement is that the `parameters` field now accepts both `dict` and `list` types, providing better developer experience and eliminating type-related errors.

## Key Changes

### 1. **Parameter Type Flexibility**
- **Before**: `parameters` field only accepted `list` type
- **After**: `parameters` field accepts both `dict` and `list` types

### 2. **Parameter Format Recommendations**
- **Recommended**: Named parameters using `:param_name` syntax
- **Supported**: Automatic conversion from positional formats (`?`, `$1`, `%s`)

### 3. **AsyncSQLDatabaseNode Consistency**
- **Clarification**: AsyncSQLDatabaseNode uses `params` (not `parameters`)
- **Result Format**: AsyncSQLDatabaseNode returns `{"result": {"data": [...]}}`

## Migration Steps

### Step 1: Update Parameter Usage

#### Before (v2.0 and earlier)
```python
from kailash.nodes.data import SQLDatabaseNode

# Only list parameters worked
db_node = SQLDatabaseNode(connection_string=connection_string)
result = db_node.run(
    query="SELECT * FROM users WHERE active = ? AND age > ?",
    parameters=[True, 18]  # Only list format supported
)
```

#### After (v2.1+)
```python
from kailash.nodes.data import SQLDatabaseNode

# Both list and dict parameters work
db_node = SQLDatabaseNode(connection_string=connection_string)

# Option 1: Named parameters (recommended)
result = db_node.run(
    query="SELECT * FROM users WHERE active = :active AND age > :min_age",
    parameters={"active": True, "min_age": 18}  # Dict format now supported
)

# Option 2: Positional parameters (still supported)
result = db_node.run(
    query="SELECT * FROM users WHERE active = ? AND age > ?",
    parameters=[True, 18]  # List format still works
)
```

### Step 2: AsyncSQLDatabaseNode Parameter Names

#### Correct Usage for AsyncSQLDatabaseNode
```python
from kailash.nodes.data import AsyncSQLDatabaseNode

async_node = AsyncSQLDatabaseNode(
    database_type="postgresql",
    host="localhost",
    port=5432,
    database="mydb",
    user="user",
    password="password"
)

# Use 'params' not 'parameters' for async node
result = await async_node.async_run(
    query="SELECT * FROM users WHERE active = :active",
    params={"active": True},  # Note: 'params' for async node
    operation="fetch_all"
)

# Access data from nested result structure
data = result["result"]["data"]
```

### Step 3: Update Error Handling

#### Common Error Patterns Fixed
```python
# These patterns now work without errors:

# 1. Dict parameters with SQLDatabaseNode (previously failed)
result = db_node.run(
    query="SELECT * FROM orders WHERE status = :status",
    parameters={"status": "pending"}  # Now works!
)

# 2. Mixed parameter usage in workflows
workflow.add_node("query1", SQLDatabaseNode(
    connection_string="postgresql://user:pass@localhost:5432/db"
))
workflow.add_runtime_parameter("query1", {
    "query": "SELECT * FROM products WHERE category = :category",
    "parameters": {"category": "electronics"}  # Dict parameters work
})
```

## Testing Your Migration

### 1. **Verify Parameter Type Flexibility**
```python
import pytest
from kailash.nodes.data import SQLDatabaseNode

def test_parameter_flexibility():
    db_node = SQLDatabaseNode(connection_string="sqlite:///:memory:")

    # Test dict parameters
    result = db_node.run(
        query="SELECT :value as test_value",
        parameters={"value": "hello"},
        operation="fetch_one"
    )
    assert result["data"][0]["test_value"] == "hello"

    # Test list parameters
    result = db_node.run(
        query="SELECT ? as test_value",
        parameters=["world"],
        operation="fetch_one"
    )
    assert result["data"][0]["test_value"] == "world"
```

### 2. **Verify AsyncSQLDatabaseNode Usage**
```python
import pytest
from kailash.nodes.data import AsyncSQLDatabaseNode

@pytest.mark.asyncio
async def test_async_parameters():
    async_node = AsyncSQLDatabaseNode(
        database_type="sqlite",
        database=":memory:"
    )

    result = await async_node.async_run(
        query="SELECT :value as test_value",
        params={"value": "async_test"},  # Note: 'params' not 'parameters'
        operation="fetch_one"
    )

    # Note: Nested result structure
    assert result["result"]["data"][0]["test_value"] == "async_test"
```

## Common Issues and Solutions

### Issue 1: Parameter Name Confusion
**Problem**: Using `parameters` with AsyncSQLDatabaseNode
```python
# ❌ Wrong
result = await async_node.async_run(
    query="SELECT * FROM users",
    parameters={"active": True}  # Wrong parameter name
)
```

**Solution**: Use `params` for AsyncSQLDatabaseNode
```python
# ✅ Correct
result = await async_node.async_run(
    query="SELECT * FROM users WHERE active = :active",
    params={"active": True}  # Correct parameter name
)
```

### Issue 2: Result Format Differences
**Problem**: Expecting same result format from both nodes
```python
# SQLDatabaseNode returns: {"data": [...]}
sql_result = db_node.run(query="SELECT * FROM users")
data = sql_result["data"]

# AsyncSQLDatabaseNode returns: {"result": {"data": [...]}}
async_result = await async_node.async_run(query="SELECT * FROM users")
data = async_result["data"]  # ❌ Wrong - will fail
```

**Solution**: Handle different result formats
```python
# ✅ Correct for AsyncSQLDatabaseNode
async_result = await async_node.async_run(query="SELECT * FROM users")
data = async_result["result"]["data"]  # Correct nested access
```

### Issue 3: Parameter Syntax Migration
**Problem**: Old parameter syntax causing issues
```python
# ❌ Old pattern that may cause issues
result = db_node.run(
    query="SELECT * FROM users WHERE status = %s",  # MySQL-style
    parameters=["active"]
)
```

**Solution**: Use named parameters for consistency
```python
# ✅ Recommended pattern
result = db_node.run(
    query="SELECT * FROM users WHERE status = :status",  # Named parameters
    parameters={"status": "active"}
)
```

## Backward Compatibility

This migration is **fully backward compatible**:

- ✅ Existing code using list parameters continues to work
- ✅ No breaking changes to method signatures
- ✅ All parameter formats automatically converted internally
- ✅ Error messages improved for better debugging

## Performance Impact

- **Minimal**: Parameter type checking adds negligible overhead
- **Improvement**: Named parameters reduce SQL injection risks
- **Consistency**: Unified parameter handling across database types

## Validation Checklist

- [ ] **All SQL nodes use correct parameter names** (`parameters` vs `params`)
- [ ] **AsyncSQLDatabaseNode result access uses nested format** (`result["result"]["data"]`)
- [ ] **Named parameters preferred over positional** (`:name` vs `?`)
- [ ] **Connection strings provided in constructor** (not runtime)
- [ ] **Tests verify both parameter types work** (dict and list)
- [ ] **Error handling updated for new patterns**

## Next Steps

1. **Update documentation** to reflect parameter flexibility
2. **Migrate existing code** to use named parameters where beneficial
3. **Update tests** to cover both parameter types
4. **Consider migrating** to WorkflowConnectionPool for production applications

## Related Guides

- [Database Connection Migration](async-sql-to-workflowconnectionpool.md) - For production apps
- [Troubleshooting Guide](../developer/05-troubleshooting.md) - Common SQL issues
- [Data Nodes Guide](../nodes/03-data-nodes.md) - Complete SQL node documentation

---

This migration enhances developer experience while maintaining full backward compatibility. The changes are primarily additive, making SQL database interactions more flexible and consistent across the SDK.
